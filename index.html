<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HERPLUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      background: url('img/fondo.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    .nav button.active {
      color: #1e90ff;
      border-bottom: 2px solid #1e90ff;
    }
    #userInfo {
      font-weight: bold;
      color: #7ec8f8;
      background: rgba(255,255,255,0.1);
      padding: 6px 10px;
      border-radius: 8px;
      backdrop-filter: blur(4px);
    }
    .movie img {
      transition: transform 0.3s ease;
    }
    .movie:hover img {
      transform: scale(1.05);
    }
    .movie {
      outline: none;
    }
    iframe {
      border: none;
    }
  </style>
</head>
<body class="text-white font-sans">

<!-- Modal Login -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
  <div class="bg-gray-800 p-8 rounded shadow-lg w-80">
    <img src="img/HERPLUS.png" class="w-24 mx-auto mb-4" />
    <input id="codigoInput" type="text" placeholder="Ingresa tu código" class="w-full p-2 rounded mb-4 text-black" />
    <button onclick="validarCodigo()" class="w-full bg-blue-600 py-2 rounded font-semibold">Ingresar</button>
    <p id="errorMsg" class="text-red-400 mt-3 text-center hidden">Código inválido o cuenta inactiva.</p>
  </div>
</div>

<!-- Encabezado -->
<header class="bg-blue-900 p-4 flex flex-col md:flex-row justify-between items-center">
  <div class="w-full md:w-1/3 text-left flex items-center gap-2">
    <img src="img/HERPLUS.png" alt="HERPLUS Logo" class="w-10 h-10" />
    <h1 class="text-xl font-bold text-white">HERPLUS</h1>
  </div>
  <div class="w-full md:w-1/3 text-center mt-2 md:mt-0" id="userInfo"></div>
  <div class="w-full md:w-1/3 text-right mt-2 md:mt-0">
    <button onclick="cerrarSesion()" class="bg-red-600 px-4 py-2 rounded">Cerrar sesión</button>
  </div>
</header>

<!-- Navegación -->
<nav class="nav bg-blue-800 flex flex-wrap justify-center gap-4 p-3 text-sm">
  <button onclick="filtrarSeccion('todos')" class="active">Todos</button>
  <button onclick="filtrarSeccion('pelicula')">Películas</button>
  <button onclick="filtrarSeccion('serie')">Series</button>
  <button onclick="filtrarSeccion('tv')">TV en Vivo</button>
  <select id="filtroCategoria" onchange="filtrarCategoria()" class="bg-gray-800 text-white px-2 py-1 rounded">
    <option value="todos">Filtrar por categoría</option>
  </select>
  <input id="searchInput" type="text" placeholder="Buscar título..." oninput="buscarPorTitulo()" class="bg-gray-700 text-white px-3 py-1 rounded" />
</nav>

<!-- Alerta de vencimiento -->
<div id="alertaMsg" class="bg-yellow-400 text-black text-center p-2 hidden"></div>

<!-- Contenido principal -->
<main class="p-4">
  <div id="contenedorSecciones" class="space-y-6"></div>
</main>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD_v8yXx1W6zcGFXXMHeNJh0RSzbnO-j84",
    authDomain: "herplus.firebaseapp.com",
    projectId: "herplus",
    storageBucket: "herplus.appspot.com",
    messagingSenderId: "556494279952",
    appId: "1:556494279952:web:f788776f50840b28434195"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let usuarioActivo = null;
  let todasLasPeliculas = [];

  function validarCodigo() {
    const codigo = document.getElementById("codigoInput").value.trim();
    db.collection("clientes").where("codigo", "==", codigo).get().then(snapshot => {
      if (snapshot.empty) return mostrarError();
      const doc = snapshot.docs[0];
      const data = doc.data();
      if (!data.activo) return mostrarError();
      const fechaRegistro = data.fechaRegistro?.toDate?.() || new Date();
      const diasRestantes = Math.max(0, (data.meses * 30) - Math.floor((Date.now() - fechaRegistro.getTime()) / (1000 * 60 * 60 * 24)));
      if (diasRestantes <= 0) return mostrarError();
      usuarioActivo = { ...data, id: doc.id, diasRestantes };
      sessionStorage.setItem("usuario", JSON.stringify(usuarioActivo));
      iniciarSesion();
    });
  }

  function mostrarError() {
    document.getElementById("errorMsg").classList.remove("hidden");
  }

  function iniciarSesion() {
    document.getElementById("loginModal").classList.add("hidden");
    document.getElementById("userInfo").textContent = `${usuarioActivo.nombre} • ${usuarioActivo.diasRestantes} día(s) restantes`;
    if (usuarioActivo.diasRestantes <= 3) {
      document.getElementById("alertaMsg").textContent = "⚠️ Tu cuenta está por vencer. Contacta a tu proveedor.";
      document.getElementById("alertaMsg").classList.remove("hidden");
    }
    cargarContenido();
  }

  function cerrarSesion() {
    sessionStorage.removeItem("usuario");
    location.reload();
  }

  function cargarContenido() {
    db.collection("peliculas").get().then(snapshot => {
      todasLasPeliculas = snapshot.docs.map(doc => doc.data());
      mostrarSecciones(todasLasPeliculas);
      llenarFiltroCategorias(todasLasPeliculas);
    });
  }

  function mostrarSecciones(peliculas) {
    const secciones = {};
    peliculas.forEach(p => {
      if (!secciones[p.categoria]) secciones[p.categoria] = [];
      secciones[p.categoria].push(p);
    });

    const cont = document.getElementById("contenedorSecciones");
    cont.innerHTML = "";
    for (let cat in secciones) {
      const div = document.createElement("div");
      div.innerHTML = `<h2 class="text-lg font-bold text-blue-300 mb-2">${cat}</h2><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">` +
        secciones[cat].map(p => `
          <div class="movie cursor-pointer" onclick='mostrarModal(${JSON.stringify(p)})'>
            <img src="${p.imagen}" class="rounded shadow w-full">
            <p class="mt-1 text-sm text-center">${p.titulo}</p>
          </div>
        `).join("") +
      `</div>`;
      cont.appendChild(div);
    }
  }

  function llenarFiltroCategorias(peliculas) {
    const filtro = document.getElementById("filtroCategoria");
    const categorias = [...new Set(peliculas.map(p => p.categoria))];
    filtro.innerHTML = `<option value="todos">Filtrar por categoría</option>` +
      categorias.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  function filtrarCategoria() {
    const cat = document.getElementById("filtroCategoria").value;
    if (cat === "todos") return mostrarSecciones(todasLasPeliculas);
    const filtrado = todasLasPeliculas.filter(p => p.categoria === cat);
    mostrarSecciones(filtrado);
  }

  function filtrarSeccion(tipo) {
    if (tipo === "todos") return mostrarSecciones(todasLasPeliculas);
    const filtrado = todasLasPeliculas.filter(p => p.seccion === tipo);
    mostrarSecciones(filtrado);
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.querySelector(`.nav button[onclick="filtrarSeccion('${tipo}')"]`).classList.add("active");
  }

  function buscarPorTitulo() {
    const texto = document.getElementById("searchInput").value.toLowerCase();
    const filtrado = todasLasPeliculas.filter(p => p.titulo.toLowerCase().includes(texto));
    mostrarSecciones(filtrado);
  }

  function mostrarModal(p) {
    const modal = document.createElement("div");
    modal.className = "fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center";
    modal.innerHTML = `
      <div class="relative w-full h-full">
        <iframe src="${p.trailer}" class="absolute inset-0 w-full h-full z-0" frameborder="0" allowfullscreen></iframe>
        <div id="overlayInfo" class="absolute top-0 left-0 w-full h-full flex flex-col justify-center items-center bg-black bg-opacity-70 text-center z-10 p-4 space-y-4">
          <img src="${p.imagen}" class="w-32 mb-2 rounded shadow">
          <h2 class="text-2xl font-bold">${p.titulo}</h2>
          <p class="px-4 max-w-xl">${p.descripcion}</p>
          <button onclick="abrirReproductor('${encodeURIComponent(p.pelicula)}', this)" class="bg-blue-600 px-4 py-2 rounded font-semibold">Ver Película</button>
          <button onclick="cerrarModal(this)" class="absolute top-4 right-4 bg-red-600 p-2 rounded-full">✕</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  function cerrarModal(btn) {
    const modal = btn.closest(".fixed");
    modal.remove();
  }

  function abrirReproductor(pelicula, btn) {
    const anteriorModal = btn.closest(".fixed");
    anteriorModal.remove();

    const contenido = decodeURIComponent(pelicula);
    const esIframe = contenido.includes("<iframe");

    const modal = document.createElement("div");
    modal.className = "fixed inset-0 bg-black z-50 flex items-center justify-center";

    modal.innerHTML = `
      <div class="relative w-full h-full">
        ${esIframe ? contenido : `<iframe src="${contenido}" class="absolute inset-0 w-full h-full" frameborder="0" allowfullscreen></iframe>`}
        <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 bg-red-600 p-2 rounded-full z-10">✕</button>
      </div>`;
    document.body.appendChild(modal);
  }

  const usuarioGuardado = sessionStorage.getItem("usuario");
  if (usuarioGuardado) {
    usuarioActivo = JSON.parse(usuarioGuardado);
    iniciarSesion();
  }
</script>
</body>
</html>





